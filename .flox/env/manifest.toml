version = 1

[install]
[vars]
[hook]
[profile]
[services]

[include]
 environments = [
     { dir = "env/common", name = "common" },
     { dir = "env/nodejs", name = "nodejs" },
     { dir = "env/android/min", name = "android-min" },
     { dir = "env/android/max", name = "android-max" },
     { dir = "env/ios", name = "ios" },
     { dir = "env/ios/min", name = "ios-min" },
     { dir = "env/ios/max", name = "ios-max" }
 ]

[build]
[build.analytics-react-native]
description = "Yarn install, build, lint, and test the monorepo"
command = """
  set -euo pipefail
  project_root="${PROJECT_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"
  cd "$project_root"
  yarn install --immutable
  yarn build
  yarn lint
  yarn test --coverage
  out_dir="${out:-${OUT:-}}"
  if [ -n "${out_dir:-}" ]; then
    mkdir -p "$out_dir/artifacts"
    for pkg in packages/core packages/sovran packages/shared packages/plugins/*; do
      if [ -d "$pkg/lib" ]; then
        dest="$out_dir/artifacts/$(basename "$pkg")"
        mkdir -p "$dest"
        cp -R "$pkg/lib" "$dest/"
      fi
    done
    if [ -d coverage ]; then
      cp -R coverage "$out_dir/coverage"
    fi
  fi
"""
[options]
