version = 1

[install]

[vars]
[hook]
 on-activate = '''
  set -euo pipefail
  project_root="${PROJECT_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"
  if [ ! -d "$project_root/env" ]; then
    project_root="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")/../../../../.." && pwd)"
  fi
  export PROJECT_ROOT="$project_root"
  export ROOT_PROJECT="$project_root"
if [ -f "$project_root/env/android/android-common/setup.sh" ]; then
  source "$project_root/env/android/android-common/setup.sh"
fi
if [ -f "$project_root/scripts/ios.sh" ]; then
  source "$project_root/scripts/ios.sh"
fi

 '''
[profile]

[include]
 environments = [
     { dir = "env/common", name = "common" },
     { dir = "env/nodejs", name = "nodejs" },
     { dir = "env/android/min", name = "android-min" },
     { dir = "env/android/latest", name = "android-latest" },
     { dir = "env/ios/min", name = "ios-min" },
     { dir = "env/ios/latest", name = "ios-latest" }
 ]


[build]
[build.analytics-react-native]
description = "Yarn install, build, lint, and test the monorepo"
command = """
  set -euo pipefail
  project_root="${PROJECT_ROOT:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"
  cd "$project_root"
  yarn install --immutable
  yarn build
  yarn lint
  yarn test --coverage
  out_dir="${out:-${OUT:-}}"
  if [ -n "${out_dir:-}" ]; then
    mkdir -p "$out_dir/artifacts"
    for pkg in packages/core packages/sovran packages/shared packages/plugins/*; do
      if [ -d "$pkg/lib" ]; then
        dest="$out_dir/artifacts/$(basename "$pkg")"
        mkdir -p "$dest"
        cp -R "$pkg/lib" "$dest/"
      fi
    done
    if [ -d coverage ]; then
      cp -R coverage "$out_dir/coverage"
    fi
  fi
"""
[options]
