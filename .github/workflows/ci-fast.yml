name: CI Fast

on:
  push:
    branches: [master, beta]
    paths-ignore:
      - 'docs/**'
      - 'wiki/**'
      - '**/*.md'
  pull_request:
    branches: [master, beta]
    paths-ignore:
      - 'docs/**'
      - 'wiki/**'
      - '**/*.md'

concurrency:
  group: ci-fast-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Checkout templates
        uses: actions/checkout@v4
        with:
          repository: segment-integrations/templates
          path: templates
      - name: Yarn cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/yarn
            .yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-
      - name: Install flox
        uses: flox/install-flox-action@v2.2.0
      - name: Build, lint, and test
        run: |
          env_dir="$(TEMPLATES_DIR="$GITHUB_WORKSPACE/templates" scripts/ci-env.sh fast)"
          flox activate -d "$env_dir" -- bash -lc "yarn install --immutable && yarn format:check && yarn test:fast"
