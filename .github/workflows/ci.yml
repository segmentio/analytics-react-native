name: CI
on:
  push:
    branches: [master, beta, ci2]
  pull_request:
    branches: [master, beta]
  workflow_dispatch:
jobs:
  cancel_previous:
    runs-on: ubuntu-latest
    steps:
      - uses: styfle/cancel-workflow-action@0.12.1
        with:
          workflow_id: ${{ github.event.workflow.id }}
  build-and-test:
    needs: cancel_previous
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@v4
      - name: Yarn cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/yarn
            .yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-
      - name: disk check
        run: df -H
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
      - name: disk check
        run: df -H
      - name: Install flox
        run: |
          curl -L https://get.flox.dev/install.sh | bash
          echo "$HOME/.flox/bin" >> "$GITHUB_PATH"
      - name: build
        run: flox activate . --devshell default -- bash flox/scripts/build.sh

  run-e2e-ios:
    if: true
    runs-on: ['macos-15' ]
    env:
      YARN_ENABLE_HARDENED_MODE: 0
      XCODE_VERSION: '26.1.1'
    strategy:
      matrix:
        include:
          - name: ios-min
            ios-device: "iPhone 14"
            ios-runtime: "18.5"
          - name: ios-latest
            ios-device: "iPhone 17"
            ios-runtime: "26.1"
    steps:
      - uses: actions/checkout@v4
      - name: Yarn cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/yarn
            .yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-
      - name: Aggressive disk cleanup (macOS)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /Applications/Android\ Studio.app
          sudo rm -rf /usr/local/share/miniconda
          sudo rm -rf "$HOME/Library/Android"
          sudo rm -rf "$HOME/.gradle"
          sudo rm -rf "$HOME/Library/Developer/CoreSimulator/Devices"
          sudo rm -rf "$HOME/Library/Developer/Xcode/DerivedData"
          df -H
      - name: disk check
        run: df -H
      - name: Free Disk Space
        run: | 
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - name: disk check
        run: df -H
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1.1'
      - name: disk check
        run: df -H
      - name: CocoaPods cache
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
          key: cocoapods-${{ runner.os }}-${{ env.XCODE_VERSION }}-${{ hashFiles('examples/E2E/ios/Podfile.lock') }}
          restore-keys: |
            cocoapods-${{ runner.os }}-${{ env.XCODE_VERSION }}-
            cocoapods-${{ runner.os }}-
      - name: DerivedData cache
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
          key: derived-${{ runner.os }}-${{ env.XCODE_VERSION }}-${{ hashFiles('examples/E2E/ios/Podfile.lock') }}
          restore-keys: |
            derived-${{ runner.os }}-${{ env.XCODE_VERSION }}-
            derived-${{ runner.os }}-
      - name: Install flox
        run: |
          curl -L https://get.flox.dev/install.sh | bash
          echo "$HOME/.flox/bin" >> "$GITHUB_PATH"
      - name: disk check
        run: df -H
      - name: iOS E2E Tests
        env:
          DETOX_IOS_DEVICE: ${{ matrix.ios-device }}
        run: flox activate . --devshell ci-ios -- bash flox/scripts/ios/test.sh

  run-e2e-android:
    if: true
    continue-on-error: true
    runs-on: 'ubuntu-22.04'
    strategy:
      matrix:
        include:
          - name: android-min
            avd-name: pixel_API21_x86_64
            skip-primary: false
            skip-secondary: true
          - name: android-latest
            avd-name: medium_phone_API33_x86_64
            skip-primary: true
            skip-secondary: false
    steps:
      - uses: actions/checkout@v4
      - name: Set AVD selection
        run: |
          echo "AVD_SKIP_PRIMARY=${{ matrix.skip-primary || 'false' }}" >> "$GITHUB_ENV"
          echo "AVD_SKIP_SECONDARY=${{ matrix.skip-secondary || 'false' }}" >> "$GITHUB_ENV"
      - name: Yarn cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/yarn
            .yarn/cache
          key: yarn-${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
      - name: disk check
        run: df -H
      - name: Install flox
        run: |
          curl -L https://get.flox.dev/install.sh | bash
          echo "$HOME/.flox/bin" >> "$GITHUB_PATH"
      - name: Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('**/buildSrc/**/*.kt') }}
          restore-keys: |
            gradle-${{ runner.os }}-
      - name: disk check
        run: df -H
      - name: Android E2E Tests
        env:
          DETOX_AVD: ${{ matrix.avd-name }}
          EMU_HEADLESS: 1
        run: flox activate . --devshell ci-android -- bash flox/scripts/android/test.sh
      - name: disk check
        run: df -H
